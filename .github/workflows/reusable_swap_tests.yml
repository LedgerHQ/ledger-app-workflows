---
name: Run Swap Functional tests

on:
  workflow_call:
    inputs:
      app_repository:
        description: 'The GIT repository to test (defaults to `github.repository`)'
        required: false
        default: ${{ github.repository }}
        type: string
      app_branch_name:
        description: 'The GIT branch to test (defaults to `github.ref`)'
        required: false
        default: ${{ github.ref }}
        type: string
      download_app_binaries_artifact:
        description: |
          The name of the artifact containing pre-built app binaries.
          If not provided, the workflow will build the app from app_repository/app_branch_name.
        required: false
        default: ''
        type: string
      use_case:
        description: 'The use case to build the application for (e.g., use_test_keys). Only applies if download_app_binaries_artifact is not provided.'
        required: false
        default: ''
        type: string
      exchange_branch_name:
        description: 'The GIT branch to build the Exchange app from (defaults to develop)'
        required: false
        default: 'develop'
        type: string
      ethereum_branch_name:
        description: 'The GIT branch to build the Ethereum app from (defaults to develop)'
        required: false
        default: 'develop'
        type: string
      regenerate_snapshots:
        description: 'Whether to regenerate the snapshots used for the tests.'
        required: false
        default: false
        type: boolean

permissions:
  contents: write       # Needed for reusable_ragger_tests.yml
  actions: write        # Needed for reusable_ragger_tests.yml and reusable_build.yml
  pull-requests: write  # Needed for reusable_ragger_tests.yml

env:
  APP_REPOSITORY: ${{ inputs.app_repository }}
  APP_BRANCH_NAME: ${{ inputs.app_branch_name }}
  DOWNLOAD_APP_BINARIES_ARTIFACT: ${{ inputs.download_app_binaries_artifact }}
  EXCHANGE_BRANCH_NAME: ${{ inputs.exchange_branch_name }}
  ETHEREUM_BRANCH_NAME: ${{ inputs.ethereum_branch_name }}
  REGENERATE_SNAPSHOTS: ${{ inputs.regenerate_snapshots }}

jobs:
  compute_artifact_names:
    name: Compute matrix-safe artifact names
    runs-on: ubuntu-latest
    outputs:
      app_binaries_artifact: ${{ steps.compute_names.outputs.app_artifact_name }}
      exchange_binaries_artifact: ${{ steps.compute_names.outputs.exchange_artifact_name }}
      ethereum_binaries_artifact: ${{ steps.compute_names.outputs.ethereum_artifact_name }}
    steps:
      - name: Compute artifact names
        id: compute_names
        run: |
          # Replace / with - to make artifact names safe for matrix strategies
          repo_safe="$(echo "${APP_REPOSITORY}" | tr '/' '-')"
          branch_safe="$(echo "${APP_BRANCH_NAME}" | tr '/' '-')"
          app_artifact_name="app_binaries-${repo_safe}-${branch_safe}"
          echo "app_artifact_name=${app_artifact_name}" >> "${GITHUB_OUTPUT}"
          echo "Computed app artifact name: ${app_artifact_name}"

          exchange_branch_safe="$(echo "${EXCHANGE_BRANCH_NAME}" | tr '/' '-')"
          # Include app repo/branch to make exchange artifact unique per matrix cell
          exchange_artifact_name="app_exchange_binaries-${exchange_branch_safe}-${repo_safe}-${branch_safe}"
          echo "exchange_artifact_name=${exchange_artifact_name}" >> "${GITHUB_OUTPUT}"
          echo "Computed exchange artifact name: ${exchange_artifact_name}"

          ethereum_branch_safe="$(echo "${ETHEREUM_BRANCH_NAME}" | tr '/' '-')"
          # Include app repo/branch to make ethereum artifact unique per matrix cell
          ethereum_artifact_name="app_ethereum_binaries-${ethereum_branch_safe}-${repo_safe}-${branch_safe}"
          echo "ethereum_artifact_name=${ethereum_artifact_name}" >> "${GITHUB_OUTPUT}"
          echo "Computed ethereum artifact name: ${ethereum_artifact_name}"

  build_app:
    name: Build app to test using the reusable workflow
    needs: compute_artifact_names
    if: ${{ inputs.download_app_binaries_artifact == '' }}
    uses: ./.github/workflows/reusable_build.yml
    with:
      app_repository: ${{ inputs.app_repository }}
      app_branch_name: ${{ inputs.app_branch_name }}
      upload_app_binaries_artifact: ${{ needs.compute_artifact_names.outputs.app_binaries_artifact }}
      use_case: ${{ inputs.use_case }}

  build_exchange:
    name: Build Exchange app using the reusable workflow
    needs: compute_artifact_names
    uses: ./.github/workflows/reusable_build.yml
    with:
      app_repository: 'LedgerHQ/app-exchange'
      app_branch_name: ${{ inputs.exchange_branch_name }}
      upload_app_binaries_artifact: ${{ needs.compute_artifact_names.outputs.exchange_binaries_artifact }}
      use_case: 'use_test_keys'

  build_ethereum:
    name: Build Ethereum app using the reusable workflow
    needs: compute_artifact_names
    uses: ./.github/workflows/reusable_build.yml
    with:
      app_repository: 'LedgerHQ/app-ethereum'
      app_branch_name: ${{ inputs.ethereum_branch_name }}
      upload_app_binaries_artifact: ${{ needs.compute_artifact_names.outputs.ethereum_binaries_artifact }}
      use_case: 'use_test_keys'

  get_swap_test_metadata:
    name: Retrieve swap test metadata
    runs-on: ubuntu-latest
    outputs:
      swap_test_dir: ${{ steps.compute_directories.outputs.swap_test_dir }}
      main_app_dir: ${{ steps.compute_directories.outputs.main_app_dir }}
      lib_app_dir: ${{ steps.compute_directories.outputs.lib_app_dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.app_repository }}
          ref: ${{ inputs.app_branch_name }}
          path: app_coin

      - name: Install ledgered
        run: python3 -m pip install ledgered

      - name: Find swap test directory and compute artifact paths
        id: compute_directories
        working-directory: app_coin
        run: |
          # Get the swap test directory using ledger-manifest
          swap_test_dir=$(ledger-manifest --output-pytest-directories -j -- ledger_app.toml | jq -r '.pytest_directories[] | select(.name == "swap") | .directory')
          if [ -z "${swap_test_dir}" ]; then
            echo "Swap test directory not found in ledger_app.toml!" >&2
            exit 1
          fi

          # Compute artifact destination directories
          main_app_dir="${swap_test_dir}/.test_dependencies/main/app-exchange/build"
          lib_app_dir="${swap_test_dir}/.test_dependencies/libraries/app-ethereum/build"

          # Output all paths
          {
            echo "swap_test_dir=${swap_test_dir}"
            echo "main_app_dir=${main_app_dir}"
            echo "lib_app_dir=${lib_app_dir}"
          } >> "${GITHUB_OUTPUT}"

          echo "Swap test directory: ${swap_test_dir}"
          echo "Exchange artifacts will be placed in: ${main_app_dir}"
          echo "Ethereum artifacts will be placed in: ${lib_app_dir}"


  # This job runs the swap functional tests using the reusable workflow
  ragger_tests_swap:
    name: Run swap functional tests
    needs: [compute_artifact_names, build_app, build_exchange, build_ethereum, get_swap_test_metadata]
    # build_app may be skipped if download_app_binaries_artifact is provided
    # Always run unless a dependency failed or was cancelled
    if: |
      always() &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled')
    uses: ./.github/workflows/reusable_ragger_tests.yml
    with:
      app_repository: ${{ inputs.app_repository }}
      app_branch_name: ${{ inputs.app_branch_name }}
      download_app_binaries_artifact: ${{ inputs.download_app_binaries_artifact != '' && inputs.download_app_binaries_artifact || needs.compute_artifact_names.outputs.app_binaries_artifact }}
      additional_app_binaries_artifact: ${{ needs.compute_artifact_names.outputs.exchange_binaries_artifact }}
      additional_app_binaries_artifact_dir: ${{ needs.get_swap_test_metadata.outputs.main_app_dir }}
      lib_binaries_artifact: ${{ needs.compute_artifact_names.outputs.ethereum_binaries_artifact }}
      lib_binaries_artifact_dir: ${{ needs.get_swap_test_metadata.outputs.lib_app_dir }}
      test_dir: ${{ needs.get_swap_test_metadata.outputs.swap_test_dir }}
      regenerate_snapshots: ${{ inputs.regenerate_snapshots }}
